class BgScript{constructor(){this.actionUrl="https://nightshift.lu/api/action/",this.uninstallUrl="https://nightshift.lu/uninstall/",this.config={},this.queue=[],this.queueProcessorReady=!1,this.uid="",this.version=chrome.runtime.getManifest().version,this.initStorage(),this.initListeners()}processQueue(){for(;0<this.queue.length;){var a=this.queue.shift();if(!a.type||"action"!=a.type)return!0;var b="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:a.action,uid:this.uid,t:Date.now()})));fetch(this.actionUrl+"?"+b).then(a=>a.json()).then(function(a){a.url&&chrome.tabs.create({url:a.url})})}}setUninstallUrl(){var a="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:"uninstall",uid:this.uid,t:Date.now()})));chrome.runtime.setUninstallURL(this.uninstallUrl+"?"+a)}initListeners(){chrome.runtime.onInstalled.addListener(a=>{"install"==a.reason&&(this.queue.push({type:"action",action:a.reason}),this.queueProcessorReady&&this.processQueue(),chrome.tabs.query({},a=>{for(let b=0;b<a.length-1;b++)this.matchUrl(a[b].url)&&(chrome.tabs.executeScript(a[b].id,{file:"./js/storage.js"},function(){const c=chrome.runtime.lastError;c&&console.log("tab: "+a[b].id+" lastError: "+JSON.stringify(c))}),chrome.tabs.executeScript(a[b].id,{file:"./js/content.js"},function(){const c=chrome.runtime.lastError;c&&console.log("tab: "+a[b].id+" lastError: "+JSON.stringify(c))}))}))}),chrome.runtime.onMessage.addListener(a=>{switch(a.action){case"storage_change":chrome.tabs.query({},a=>{for(let b=0;b<a.length-1;b++)this.matchUrl(a[b].url)&&chrome.tabs.sendMessage(a[b].id,{action:"storage_change_cs"})});}}),chrome.webRequest.onBeforeRequest.addListener(a=>{if("https://www.youtube.com"==a.initiator&&a.url.match("://fonts.googleapis.com/css")&&"https://fonts.googleapis.com/css?family=YT%20Sans%3A300%2C500%2C700"==a.url)return{redirectUrl:chrome.runtime.getURL("css/yt.css")}},{urls:["*://www.youtube.com/*","*://fonts.googleapis.com/*"]},["blocking"])}initStorage(){chrome.storage.local.get(a=>{a&&a.config&&(this.config=a.config),this.config.uid?this.uid=this.config.uid:(this.uid=this.config.uid=this.generateUID(),this.saveConfig()),this.queueProcessorReady=!0,this.setUninstallUrl(),this.processQueue()})}saveConfig(){chrome.storage.local.set({config:this.config})}generateUID(){return"xxxxxxxx-xxxx-2xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})}matchUrl(a){return!!a&&!a.match("https://chrome.google.com")&&(!!a.match("http://")||!!a.match("https://")||!!a.match("file:///"))}}const bgScript=new BgScript;